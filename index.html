miooi<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job Miner – Web MVP</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:24px; }
    .container { max-width: 960px; margin:0 auto; }
    h1 { margin:0 0 16px; }
    form { display:grid; grid-template-columns:1fr 1fr; gap:12px 16px; }
    .full { grid-column:1 / -1; }
    label { font-size:12px; color:#444; display:block; margin-bottom:4px; }
    input[type=text],input[type=number],input[type=file],select { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    .inline { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .actions { margin-top:16px; display:flex; gap:12px; }
    button { background:#3b82f6; color:#fff; border:none; border-radius:6px; padding:10px 14px; cursor:pointer; }
    button[disabled] { background:#9ca3af; cursor:not-allowed; }
    #msg { font-size:13px; }
    .hint { font-size:12px; color:#555; margin-bottom:20px; }
    footer { margin-top:40px; font-size:11px; color:#666; }
    .env-note { background:#fef3c7; padding:8px 12px; border:1px solid #fcd34d; border-radius:6px; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Job Miner – Web MVP</h1>
  <p class="hint">Upload your resume and enter search criteria. Processing now happens asynchronously – you'll see live status updates and can download when ready.</p>
    <div class="env-note">If this page is served from GitHub Pages the API must run locally or on a deployed host. Set <code>JOBMINER_API_BASE</code> below if auto-detection fails.</div>

    <form id="job-form">
      <div class="full">
        <label for="api_base">API Base (optional override)</label>
        <input type="text" id="api_base" placeholder="http://127.0.0.1:8000" />
      </div>
      <div class="full">
        <details>
          <summary style="cursor:pointer;font-size:12px;">Adzuna credentials (optional – only fill if not set on server)</summary>
          <label for="adzuna_app_id">Adzuna App ID</label>
          <input type="text" id="adzuna_app_id" name="app_id" placeholder="Your Adzuna App ID" />
          <label for="adzuna_app_key" style="margin-top:8px;">Adzuna App Key</label>
          <input type="text" id="adzuna_app_key" name="app_key" placeholder="Your Adzuna App Key" />
          <p class="hint" style="margin-top:8px;">Values are stored locally in this browser only (localStorage) and sent with the form when present.</p>
        </details>
      </div>
      <div class="full">
        <label for="resume">Resume (PDF/DOCX)</label>
        <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" required />
      </div>
      <div>
        <label for="title">Job title (required)</label>
        <input type="text" id="title" name="title" placeholder="Data Engineer" required />
      </div>
      <div>
        <label for="location">Location (required)</label>
        <input type="text" id="location" name="location" placeholder="New York, NY" required />
      </div>
      <div>
        <label for="distance">Distance (miles)</label>
        <input type="number" id="distance" name="distance" min="1" max="250" value="25" required />
      </div>
      <div>
        <label for="date_posted">Date posted</label>
        <select id="date_posted" name="date_posted">
          <option value="">Any</option>
          <option value="1">Last 24h</option>
          <option value="3">Last 3 days</option>
          <option value="7">Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>
      <div>
        <label for="work_mode">Work mode</label>
        <select id="work_mode" name="work_mode">
          <option value="">Any</option>
          <option value="onsite">On-site</option>
            <option value="hybrid">Hybrid</option>
          <option value="remote">Remote</option>
        </select>
      </div>
      <div>
        <label for="employment_type">Employment type</label>
        <select id="employment_type" name="employment_type">
          <option value="">Any</option>
          <option value="full_time">Full-time</option>
          <option value="part_time">Part-time</option>
          <option value="contract">Contract</option>
          <option value="temporary">Temporary</option>
          <option value="internship">Internship</option>
        </select>
      </div>
      <div>
        <label for="salary">Salary expectation (annual)</label>
        <input type="number" id="salary" name="salary" min="0" step="1000" />
      </div>
      <div>
        <label for="limit">Result limit</label>
        <select id="limit" name="limit">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50" selected>50</option>
          <option value="60">60</option>
          <option value="70">70</option>
          <option value="80">80</option>
          <option value="90">90</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="full actions">
        <button type="submit" id="runBtn">Start Job</button>
        <button type="button" id="downloadBtn" disabled>Download CSV</button>
      </div>
      <div class="full"><div id="msg"></div></div>
    </form>

    <footer>
      <p>Remember: The API must run locally (uvicorn) or be deployed (e.g. https://your-app.fly.dev). This static page cannot parse resumes or score jobs by itself.</p>
    </footer>
  </div>

<script>
(function(){
  const form = document.getElementById('job-form');
  const runBtn = document.getElementById('runBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const msg = document.getElementById('msg');
  const apiBaseInput = document.getElementById('api_base');
  const adzunaAppIdInput = document.getElementById('adzuna_app_id');
  const adzunaAppKeyInput = document.getElementById('adzuna_app_key');
  let currentJobId = null;
  let pollTimer = null;

  // Attempt auto base: if served from GitHub Pages assume localhost backend unless overridden
  const defaultBase = 'http://127.0.0.1:8000';
  apiBaseInput.value = localStorage.getItem('JOBMINER_API_BASE') || defaultBase;
  if(adzunaAppIdInput) adzunaAppIdInput.value = localStorage.getItem('ADZUNA_APP_ID') || '';
  if(adzunaAppKeyInput) adzunaAppKeyInput.value = localStorage.getItem('ADZUNA_APP_KEY') || '';

  function apiBase() {
    const v = apiBaseInput.value.trim() || defaultBase;
    localStorage.setItem('JOBMINER_API_BASE', v);
    return v.replace(/\/$/, '');
  }

  async function startJob(fd){
    const res = await fetch(apiBase() + '/api/jobs', { method:'POST', body: fd });
    if(!res.ok){
      let detail = res.status + ' error';
      try { const j = await res.json(); if(j && j.detail) detail = j.detail; } catch(_e){}
      throw new Error(detail);
    }
    const data = await res.json();
    return data.job_id;
  }

  async function poll(jobId){
    try {
      const res = await fetch(apiBase() + '/api/jobs/' + encodeURIComponent(jobId));
      if(!res.ok){ throw new Error('status ' + res.status); }
      const j = await res.json();
      if(j.status === 'done'){
        clearInterval(pollTimer); pollTimer = null; runBtn.disabled = false; downloadBtn.disabled = false;
        msg.textContent = `Done. ${j.count} jobs processed in ~${(j.timings.total_sec||0)}s.`;
        downloadBtn.onclick = () => {
          window.location.href = apiBase() + '/api/jobs/' + jobId + '/download';
        };
      } else if (j.status === 'error') {
        clearInterval(pollTimer); pollTimer = null; runBtn.disabled = false;
        msg.textContent = 'Error: ' + (j.error || 'Unknown');
      } else {
        // Compose progress message
        let phase = j.status;
        const t = j.timings || {};
        const parts = [];
        if(t.fetch_sec) parts.push('fetch ' + t.fetch_sec + 's');
        if(t.scoring_sec) parts.push('score ' + t.scoring_sec + 's');
        if(t.export_sec) parts.push('export ' + t.export_sec + 's');
        msg.textContent = `Job ${jobId.slice(0,8)}: ${phase} … ${parts.join(', ')}`;
      }
    } catch(e){
      console.error('poll error', e);
    }
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
    msg.textContent=''; downloadBtn.disabled = true; runBtn.disabled = true; runBtn.textContent='Starting…';
    const fd = new FormData(form);
    for(const f of ['title','location','distance']){ if(!fd.get(f)){ msg.textContent='Missing required field: '+f; runBtn.disabled=false; runBtn.textContent='Start Job'; return; } }
    if(fd.has('salary') && (fd.get('salary')==='' || fd.get('salary')===null)) fd.delete('salary');
    if(adzunaAppIdInput && adzunaAppIdInput.value.trim()) localStorage.setItem('ADZUNA_APP_ID', adzunaAppIdInput.value.trim());
    if(adzunaAppKeyInput && adzunaAppKeyInput.value.trim()) localStorage.setItem('ADZUNA_APP_KEY', adzunaAppKeyInput.value.trim());
    try {
      currentJobId = await startJob(fd);
      msg.textContent = 'Job queued…';
      runBtn.textContent='Running…';
      pollTimer = setInterval(()=> poll(currentJobId), 2500);
    } catch(err){
      runBtn.disabled=false; runBtn.textContent='Start Job';
      msg.textContent = 'Failed: ' + (err.message || 'Unknown');
    }
  });
})();
</script>
</body>
</html>
